{% extends "admin/layout.html" %}
{% block content %}

<div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
    <h2 style="margin:0;">System Monitor</h2>

    <form id="shutdownForm" style="margin:0;">
        <button
            type="button"
            style="
                background:#c00;
                color:white;
                border:none;
                padding:8px 14px;
                border-radius:6px;
                cursor:pointer;
                font-weight:600;
            ">
            ☠️ Убить контейнер
        </button>
    </form>
</div>

<table>
<tr><th>ЦПУ</th><td id="cpu">--</td></tr>
<tr><th>РАМ</th><td id="ram">--</td></tr>
<tr><th>Load</th><td id="load">--</td></tr>
<tr><th>Threads</th><td id="threads">--</td></tr>
<tr><th>Время работы</th><td id="uptime">--</td></tr>
</table>

<canvas id="cpuChart" style="max-width:100%;"></canvas>
<br>
<canvas id="ramChart" style="max-width:100%;"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Простой монитор без Ably (если публичный ключ не установлен)
let cpuData = [], ramData = [], labels = [];

const commonOptions = {
    animation: { duration: 200 },
    responsive: true,
    maintainAspectRatio: true,
    scales: {
        x: { display: false },
        y: {
            beginAtZero: true,
            max: 100,
            ticks: { color: "#ccc" },
            grid: { color: "rgba(255,255,255,0.05)" }
        }
    },
    plugins: {
        legend: { labels: { color: "#eee" } }
    }
};

const cpuCtx = document.getElementById('cpuChart')?.getContext('2d');
const ramCtx = document.getElementById('ramChart')?.getContext('2d');

let cpuChart = null, ramChart = null;

if (cpuCtx && ramCtx) {
    cpuChart = new Chart(cpuCtx, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'CPU %',
                data: cpuData,
                borderColor: '#ff4d4f',
                backgroundColor: 'rgba(255,77,79,0.15)',
                tension: 0.3,
                fill: true,
                pointRadius: 0
            }]
        },
        options: commonOptions
    });

    ramChart = new Chart(ramCtx, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'RAM %',
                data: ramData,
                borderColor: '#4dabf7',
                backgroundColor: 'rgba(77,171,247,0.15)',
                tension: 0.3,
                fill: true,
                pointRadius: 0
            }]
        },
        options: commonOptions
    });
}

async function updateMetrics() {
    try {
        const res = await fetch('/admin/monitor');
        if (!res.ok) return;
        
        const data = await res.json();
        
        labels.push(new Date().toLocaleTimeString());
        cpuData.push(data.cpu || 0);
        ramData.push(Math.round((data.ram / data.ram_total) * 100) || 0);
        
        if (labels.length > 60) {
            labels.shift();
            cpuData.shift();
            ramData.shift();
        }
        
        if (cpuChart) cpuChart.update('none');
        if (ramChart) ramChart.update('none');
        
        document.getElementById("cpu").innerText = (data.cpu || 0) + " %";
        document.getElementById("ram").innerText = `${Math.round((data.ram / 1024))} MB (${Math.round((data.ram / data.ram_total) * 100)}%)`;
        document.getElementById("load").innerText = (data.load_avg || [0,0,0]).map(x => x.toFixed(2)).join(", ");
        document.getElementById("threads").innerText = "--";
        
        const h = Math.floor((data.uptime || 0) / 3600);
        const m = Math.floor(((data.uptime || 0) % 3600) / 60);
        const s = Math.floor((data.uptime || 0) % 60);
        document.getElementById("uptime").innerText = `${h}h ${m}m ${s}s`;
    } catch (error) {
        console.error('Error fetching metrics:', error);
    }
}

updateMetrics();
setInterval(updateMetrics, 1000);

document.getElementById("shutdownForm").addEventListener("submit", async e => {
    e.preventDefault();
    if (!confirm("Контейнер будет немедленно остановлен. Продолжить?")) return;
    
    try {
        await fetch("/admin/shutdown", { method: "POST" });
        alert("Контейнер остановлен.");
    } catch (error) {
        console.error('Error:', error);
    }
});
</script>

<style>
canvas {
    display: block;
    margin-bottom: 16px;
}
</style>

{% endblock %}
