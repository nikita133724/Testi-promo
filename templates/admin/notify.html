{% extends "admin/layout.html" %}
{% block content %}
<h2>Отправка уведомлений</h2>

<form id="notify-form">
    <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="recipient_type" value="all" checked> Всем
    </label>
    <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="recipient_type" value="single"> Конкретному пользователю
    </label>

    <div id="user-search-container" style="display:none; margin-top:10px; margin-bottom:10px;">
        <input type="text" id="user-search" placeholder="Введите username или chat_id" style="padding:8px; width:300px; max-width:100%; border:1px solid #ccc; border-radius:4px;">
        <ul id="search-results" style="list-style:none; padding:0; margin-top:5px; background:white; border:1px solid #ccc; border-radius:4px; max-height:200px; overflow-y:auto;"></ul>
    </div>

    <textarea name="message" placeholder="Текст уведомления" style="width:100%; height:100px; margin-top:10px; padding:8px; border:1px solid #ccc; border-radius:4px; font-family:Arial;"></textarea>
    <button type="submit" style="margin-top:10px; padding:8px 16px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer;">Отправить</button>
</form>

<div id="status" style="margin-top:20px; color:green;"></div>

<script>
const recipientRadios = document.querySelectorAll('input[name="recipient_type"]');
const searchContainer = document.getElementById('user-search-container');
const searchInput = document.getElementById('user-search');
const searchResults = document.getElementById('search-results');

recipientRadios.forEach(radio => {
    radio.addEventListener('change', () => {
        searchContainer.style.display = radio.value === 'single' ? 'block' : 'none';
    });
});

let timeout = null;
searchInput.addEventListener('input', () => {
    clearTimeout(timeout);
    timeout = setTimeout(async () => {
        const query = searchInput.value.trim();
        if (!query) {
            searchResults.innerHTML = '';
            return;
        }
        try {
            const res = await fetch(`/admin/search_users?q=${encodeURIComponent(query)}`);
            const users = await res.json();
            searchResults.innerHTML = users.map(u => `<li data-uid="${u.chat_id}" style="cursor:pointer; padding:8px; border-bottom:1px solid #eee;">${u.display_name || u.username || u.chat_id}</li>`).join('');
            
            searchResults.querySelectorAll('li').forEach(li => {
                li.addEventListener('click', () => {
                    searchInput.value = li.dataset.uid;
                    searchResults.innerHTML = '';
                });
            });
        } catch (error) {
            console.error('Error:', error);
        }
    }, 300);
});

document.getElementById('notify-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    try {
        const res = await fetch('/admin/notify', {
            method: 'POST',
            body: formData
        });
        const data = await res.json();
        const statusDiv = document.getElementById('status');
        if (data.status === 'ok') {
            statusDiv.textContent = '✅ Уведомление отправлено';
            statusDiv.style.color = 'green';
        } else {
            statusDiv.textContent = '❌ ' + (data.error || 'Ошибка');
            statusDiv.style.color = 'red';
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('status').textContent = '❌ Ошибка при отправке';
        document.getElementById('status').style.color = 'red';
    }
});
</script>
{% endblock %}
