{% extends "admin/layout.html" %}
{% block content %}
<h2>Отправка уведомлений</h2>

<form id="notify-form">
  <div>
    <label>Тип получателя:</label>
    <input type="radio" name="recipient_type" value="all" checked> Все
    <input type="radio" name="recipient_type" value="single"> Один пользователь
  </div>

  <div id="user-search-container" style="display:none;">
    <input type="text" id="user-search" name="target_user" placeholder="Введите username или имя пользователя">
    <ul id="search-results" style="list-style:none; padding:0; margin:0;"></ul>
  </div>

  <div>
    <label>Сообщение:</label>
    <textarea name="message" required></textarea>
  </div>

  <button type="submit">Отправить</button>
</form>

<div id="status"></div>

<script>
function initNotifyForm() {
    const recipientRadios = document.querySelectorAll('input[name="recipient_type"]');
    const searchContainer = document.getElementById('user-search-container');
    const searchInput = document.getElementById('user-search');
    const searchResults = document.getElementById('search-results');
    const form = document.getElementById('notify-form');
    const statusDiv = document.getElementById('status');

    // Переключение видимости поля поиска
    recipientRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            searchContainer.style.display = radio.value === 'single' ? 'block' : 'none';
        });
    });

    // Поиск пользователей
    let timeout = null;
    searchInput.addEventListener('input', () => {
        clearTimeout(timeout);
        timeout = setTimeout(async () => {
            const query = searchInput.value.trim();
            if (!query) {
                searchResults.innerHTML = '';
                return;
            }
            const res = await fetch(`/admin/search_users?q=${encodeURIComponent(query)}`);
            const users = await res.json(); // ожидаем [{chat_id, username, display_name}, ...]
            searchResults.innerHTML = users.map(u =>
                `<li data-chat-id="${u.chat_id}" style="cursor:pointer;">
                    ${u.username ? '@' + u.username : u.display_name || u.chat_id}
                </li>`).join('');
        }, 300);
    });

    // Выбор пользователя из списка
    searchResults.addEventListener('click', (e) => {
        if (e.target.tagName === 'LI') {
            searchInput.value = e.target.dataset.chatId; // сохраняем chat_id
            searchResults.innerHTML = '';
        }
    });

    // Отправка формы
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const res = await fetch('/admin/notify', {
            method: 'POST',
            body: formData
        });
        const data = await res.json();

        if (data.status === 'ok') {
            statusDiv.style.color = 'green';
            statusDiv.textContent = `✅ Уведомление отправлено (${data.sent} пользователей)`;
        } else if (data.status === 'partial') {
            statusDiv.style.color = 'orange';
            statusDiv.textContent = `⚠ Отправлено ${data.sent}, не доставлено: ${data.failed.map(f => f.chat_id).join(", ")}`;
        } else {
            statusDiv.style.color = 'red';
            statusDiv.textContent = '❌ ' + (data.error || 'Ошибка отправки');
        }
    });
}

// SPA-рендер
initNotifyForm();
</script>
{% endblock %}
