{% extends "admin/layout.html" %}
{% block content %}
<h2>Отправка уведомлений</h2>

<form id="notify-form">
    <label>
        <input type="radio" name="recipient_type" value="all" checked> Всем
    </label>
    <label>
        <input type="radio" name="recipient_type" value="single"> Конкретному пользователю
    </label>

    <div id="user-search-container" style="display:none; margin-top:10px;">
        <input type="text" id="user-search" placeholder="Введите username или chat_id">
        <ul id="search-results" style="list-style:none; padding:0;"></ul>
    </div>

    <textarea name="message" placeholder="Текст уведомления" style="width:100%; height:100px; margin-top:10px;"></textarea>
    <button type="submit" style="margin-top:10px;">Отправить</button>
</form>

<div id="status" style="margin-top:20px; color:green;"></div>

<script>
const recipientRadios = document.querySelectorAll('input[name="recipient_type"]');
const searchContainer = document.getElementById('user-search-container');
const searchInput = document.getElementById('user-search');
const searchResults = document.getElementById('search-results');

recipientRadios.forEach(radio => {
    radio.addEventListener('change', () => {
        searchContainer.style.display = radio.value === 'single' ? 'block' : 'none';
    });
});

let timeout = null;
searchInput.addEventListener('input', () => {
    clearTimeout(timeout);
    timeout = setTimeout(async () => {
        const query = searchInput.value.trim();
        if (!query) {
            searchResults.innerHTML = '';
            return;
        }
        const res = await fetch(`/admin/search_users?q=${encodeURIComponent(query)}`);
        const users = await res.json();
        searchResults.innerHTML = users.map(u => `<li data-uid="${u.chat_id}" style="cursor:pointer;">${u.display_name || u.username || u.chat_id}</li>`).join('');
    }, 300);
});

searchResults.addEventListener('click', (e) => {
    if (e.target.tagName === 'LI') {
        searchInput.value = e.target.dataset.uid;
        searchResults.innerHTML = '';
    }
});

document.getElementById('notify-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const res = await fetch('/admin/notify', {
        method: 'POST',
        body: formData
    });
    const data = await res.json();
    const statusDiv = document.getElementById('status');

    if (data.status === 'ok') {
        statusDiv.style.color = 'green';
        statusDiv.textContent = `✅ Уведомление отправлено (${data.sent} пользователей)`;
    } else if (data.status === 'partial') {
        statusDiv.style.color = 'orange';
        statusDiv.textContent = `⚠ Отправлено ${data.sent}, не доставлено: ${data.failed.map(f => f.chat_id).join(", ")}`;
    } else {
        statusDiv.style.color = 'red';
        statusDiv.textContent = '❌ ' + (data.error || 'Ошибка отправки');
    }
});
</script>
{% endblock %}
