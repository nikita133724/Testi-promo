{% extends "admin/layout.html" %}

{% block content %}
<h2>Транзакции</h2>

<div style="margin-bottom: 16px;">
    <input id="search-input" placeholder="Поиск по chat_id или ID YooMoney" style="padding:6px; width: 300px;">
    <button class="filter-btn active" onclick="filterTransactions('all', this)">Все</button>
    <button class="filter-btn" onclick="filterTransactions('paid', this)">Оплаченные</button>
    <button class="filter-btn" onclick="filterTransactions('failed', this)">Неудачные</button>
    <button class="filter-btn" onclick="filterTransactions('pending', this)">В обработке</button>
</div>

<table>
    <thead>
        <tr>
            <th>№ платежа</th>
            <th>Пользователь</th>
            <th>Сумма</th>
            <th>Статус</th>
            <th>Создано</th>
            <th>ID платежа YooMoney</th>
        </tr>
    </thead>
    <tbody id="transactions-table">
        {% for t in transactions %}
        <tr>
            <td>{{ t.order_id }}</td>
            <td>{{ t.chat_id }}</td>
            <td>{{ t.amount }} ₽</td>
            <td>{{ t.status }}</td>
            <td>{{ t.created_at }}</td>
            <td>{{ t.operation_id if t.operation_id else '-' }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
let currentStatus = 'all';
const tableBody = document.getElementById('transactions-table');

function formatTimestamp(ts) {
    if (!ts) return '-';
    const date = new Date(ts * 1000); // из секунд -> миллисекунды
    return date.toLocaleString(undefined, { hour12: false });
}

async function filterTransactions(status, btn) {
    currentStatus = status;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    await updateTable();
}

document.getElementById('search-input').addEventListener('input', async () => {
    await updateTable();
});

async function updateTable() {
    const search = document.getElementById('search-input').value.toLowerCase();
    const resp = await fetch(`/admin/transactions/filter?status=${currentStatus}&search=${encodeURIComponent(search)}`, {
        headers: {"X-Requested-With":"SPA"}
    });
    const transactions = await resp.json();

    tableBody.innerHTML = '';
    transactions.forEach(t => {
        // поиск по chat_id, operation_id и order_id
        if (search &&
            !String(t.chat_id).toLowerCase().includes(search) &&
            !(t.operation_id && t.operation_id.toLowerCase().includes(search)) &&
            !String(t.order_id).toLowerCase().includes(search)
        ) {
            return;
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${t.order_id}</td>
                        <td>${t.chat_id}</td>
                        <td>${t.amount} ₽</td>
                        <td>${t.status}</td>
                        <td>${formatTimestamp(t.created_at)}</td>
                        <td>${t.operation_id ? t.operation_id : '-'}</td>`;
        tableBody.appendChild(tr);
    });
}
// initial load
updateTable();
</script>
{% endblock %}