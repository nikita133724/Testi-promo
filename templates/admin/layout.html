<script>
(function(){
    const contentRoot = document.querySelector('.content')
    if(!contentRoot){
        return
    }
    const getUrl = raw => new URL(raw, window.location.href).href
    const pushState = url => window.history.pushState({url}, '', url)
    const replaceState = url => window.history.replaceState({url}, '', url)
    replaceState(window.location.href)
    const loadPage = async (rawUrl, options = {}) => {
        const url = getUrl(rawUrl)
        const method = (options.method || 'GET').toUpperCase()
        const headers = {'X-Requested-With': 'SPA', ...(options.headers || {})}
        const fetchOptions = {method, credentials: 'same-origin', headers}
        if(method !== 'GET' && options.body){
            fetchOptions.body = options.body
        }
        const response = await fetch(url, fetchOptions)
        if(response.redirected){
            const target = response.url
            if(!target){
                throw new Error('redirect failed')
            }
            return loadPage(target, {
                method: 'GET',
                updateHistory: options.updateHistory !== false
            })
        }
        if(!response.ok){
            throw new Error('request failed')
        }
        const text = await response.text()
        const parser = new DOMParser()
        const doc = parser.parseFromString(text, 'text/html')
        const newContent = doc.querySelector('.content')
        if(!newContent){
            window.location.href = url
            return
        }
        const scripts = Array.from(newContent.querySelectorAll('script'))
        scripts.forEach(node => node.remove())
        contentRoot.innerHTML = newContent.innerHTML
        scripts.forEach(old => {
            const script = document.createElement('script')
            Array.from(old.attributes).forEach(attr => script.setAttribute(attr.name, attr.value))
            script.textContent = old.textContent
            contentRoot.appendChild(script)
        })
        document.title = doc.title || document.title
        if(options.updateHistory === false){
            replaceState(url)
        } else if(options.skipHistory !== true){
            pushState(url)
        }
    }
    const safeLoad = (url, options = {}) => {
        loadPage(url, options).catch(() => {
            window.location.href = url
        })
    }
    document.body.addEventListener('click', event => {
        const anchor = event.target.closest('a')
        if(!anchor){
            return
        }
        if(anchor.target && anchor.target !== '_self'){
            return
        }
        const href = anchor.getAttribute('href')
        if(!href || href.startsWith('#')){
            return
        }
        const url = new URL(href, window.location.href)
        if(url.origin !== window.location.origin){
            return
        }
        if(!anchor.closest('.sidebar') && !anchor.closest('.content')){
            return
        }
        event.preventDefault()
        safeLoad(url.href)
    })
    document.body.addEventListener('submit', event => {
        const form = event.target
        if(!form || !contentRoot.contains(form)){
            return
        }
        event.preventDefault()
        const formData = new FormData(form)
        const params = new URLSearchParams(formData)
        const method = (form.method || 'GET').toUpperCase()
        const action = form.action || window.location.href
        const url = new URL(action, window.location.href)
        if(method === 'GET'){
            const query = params.toString()
            const finalUrl = query ? `${url.origin}${url.pathname}?${query}` : `${url.origin}${url.pathname}`
            safeLoad(finalUrl)
            return
        }
        safeLoad(url.href, {
            method,
            body: params.toString(),
            headers: {'Content-Type': 'application/x-www-form-urlencoded'}
        })
    })
    window.addEventListener('popstate', event => {
        const target = (event.state && event.state.url) || window.location.href
        loadPage(target, {updateHistory: false, skipHistory: true}).catch(() => {
            window.location.href = target
        })
    })
})()
</script>