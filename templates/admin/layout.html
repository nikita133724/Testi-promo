<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        :root{
            font-family: "Inter", "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;
            --bg-1: #0f172a;
            --bg-2: #111827;
            --muted: #94a3b8;
            --panel: linear-gradient(180deg,#0b1220,#111827);
            --input-bg: rgba(148,163,184,0.12);
            --border: rgba(148,163,184,0.3);
            --accent: #38bdf8;
            color: #f1f5f9;
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; background: var(--bg-1); color: #f1f5f9; }

        .wrapper {
            display: flex;
            min-height: 100vh;
            align-items: flex-start;
            justify-content: center;
            padding: 24px;
            gap: 20px;
        }

        .panel {
            width: min(1200px, 100%);
            background: var(--panel);
            border-radius: 20px;
            padding: 18px;
            box-shadow: 0 20px 50px rgba(15,23,42,0.6);
            border: 1px solid var(--border);
            display: flex;
            gap: 18px;
            overflow: hidden;
        }

        .sidebar {
            width: 220px;
            background: linear-gradient(180deg,#0b1220,#0f172a);
            padding: 20px;
            border-radius: 12px;
            color: #e6eef8;
            flex-shrink: 0;
        }
        .sidebar h2 { margin: 0 0 12px; font-size: 18px; }
        .sidebar a {
            display: block;
            color: #cfe8ff;
            text-decoration: none;
            margin: 8px 0;
            padding: 10px 12px;
            border-radius: 10px;
            transition: background .15s ease, transform .08s ease;
            font-weight: 600;
        }
        .sidebar a:hover { background: rgba(255,255,255,0.02); transform: translateX(4px); }

        .content {
            flex: 1;
            padding: 22px;
            overflow-y: auto;
            min-width: 0;
        }

        .content h1, .content h2, .content h3 { margin: 0 0 14px; color: #e6eef8; }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 18px;
            background: transparent;
            color: #e6eef8;
        }
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(148,163,184,0.06);
            font-size: 14px;
        }
        th {
            background: rgba(255,255,255,0.02);
            color: #dbeafe;
            font-weight: 700;
        }
        tr:nth-child(even) td { background: rgba(255,255,255,0.01); }

        .field-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--muted);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        input[type="text"], input[type="password"], select, textarea {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid rgba(148,163,184,0.28);
            border-radius: 12px;
            padding: 12px 14px;
            font-size: 15px;
            color: #f8fafc;
            outline: none;
            transition: border-color .18s ease, box-shadow .12s ease;
        }
        input:focus, textarea:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(56,189,248,0.06); }

        button, .btn {
            display: inline-block;
            border: none;
            border-radius: 14px;
            padding: 12px 16px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            background: var(--accent);
            color: #0f172a;
            transition: transform .12s ease;
        }
        button:active, .btn:active { transform: translateY(1px); }
        .btn.ghost {
            background: rgba(148,163,184,0.08);
            color: #cbd5e1;
            border: 1px solid rgba(148,163,184,0.18);
        }

        .error {
            margin: 0 0 12px;
            padding: 10px;
            border-radius: 10px;
            background: rgba(248,113,113,0.12);
            border: 1px solid rgba(248,113,113,0.28);
            color: #fecaca;
            font-size: 14px;
        }

        .muted { color: var(--muted); }
        .filters { display:flex; gap:8px; margin-bottom:12px; }
        .filter-btn {
            padding: 6px 10px;
            border-radius: 10px;
            background: rgba(148,163,184,0.06);
            color: #cbd5e1;
            cursor: pointer;
            border: none;
            font-weight: 600;
        }
        .filter-btn.active { background: #4CAF50; color: white; }

        @media (max-width: 900px) {
            .panel { flex-direction: column; padding: 14px; border-radius: 16px; }
            .sidebar { width: 100%; display:flex; gap:8px; padding: 10px; overflow-x:auto; }
            .content { padding: 14px; }
        }
    </style>
</head>

<body>
<div class="wrapper">
    <div class="panel">
        <aside class="sidebar">
            <h2>Admin</h2>
            <a href="/admin/users">Пользователи</a>
            <a href="/admin/keys">Генерация ключей</a>
            <a href="/admin/stats">Статистика по постам</a>
            <a href="/admin/monitor">Мониторинг</a>

            {% if request.session.get("is_admin") %}
                <a href="/logout" style="margin-top:8px;">Выйти</a>
            {% endif %}
        </aside>

        <main class="content">
            {% block content %}{% endblock %}
        </main>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const contentRoot = document.querySelector(".content");
    if (!contentRoot) {
        return;
    }

    const parser = new DOMParser();
    const getAbsoluteUrl = raw => new URL(raw, window.location.href).href;
    const pushHistory = (url, replace = false) => {
        if (replace) {
            window.history.replaceState({ url }, "", url);
        } else {
            window.history.pushState({ url }, "", url);
        }
    };
    pushHistory(window.location.href, true);

    const render = (html, url, { replace = false } = {}) => {
        const doc = parser.parseFromString(html, "text/html");
        const newContent = doc.querySelector(".content");
        if (!newContent) {
            throw new Error("content wrapper missing");
        }

        const scripts = Array.from(newContent.querySelectorAll("script"));
        scripts.forEach(script => script.remove());
        if (window.__cleanupMonitor) {
            window.__cleanupMonitor();
            delete window.__cleanupMonitor;
        }
        contentRoot.innerHTML = newContent.innerHTML;

        scripts.forEach(oldScript => {
            const script = document.createElement("script");
            Array.from(oldScript.attributes).forEach(attr => {
                script.setAttribute(attr.name, attr.value);
            });
            script.textContent = oldScript.textContent;
            contentRoot.appendChild(script);
        });

        document.title = doc.title || document.title;
        pushHistory(url, replace);
    };

    const safeFetch = async (url, options = {}) => {
        try {
            const response = await fetch(url, {
                method: options.method || "GET",
                headers: {
                    "X-Requested-With": "SPA",
                    ...(options.headers || {})
                },
                body: options.body,
                credentials: "same-origin"
            });

            if (response.redirected) {
                return { redirected: true, url: response.url };
            }
            if (!response.ok) {
                throw new Error("network");
            }
            return { html: await response.text() };
        } catch (error) {
            return { error };
        }
    };

    const load = async (rawUrl, options = {}) => {
        const url = getAbsoluteUrl(rawUrl);
        const result = await safeFetch(url, options);

        if (result.redirected) {
            return load(result.url, { method: "GET", replace: options.replace });
        }
        if (result.error || !result.html) {
            window.location.href = url;
            return;
        }

        try {
            render(result.html, url, { replace: options.replace });
        } catch {
            window.location.href = url;
        }
    };

    document.body.addEventListener("click", event => {
        const anchor = event.target.closest("a");
        if (!anchor || anchor.target === "_blank" || anchor.href.startsWith("javascript:")) {
            return;
        }
        const url = new URL(anchor.href, window.location.href);
        if (url.origin !== window.location.origin) {
            return;
        }
        if (!anchor.closest(".sidebar") && !anchor.closest(".content")) {
            return;
        }
        event.preventDefault();
        load(url.href, { replace: false });
    });

    document.body.addEventListener("submit", event => {
        const form = event.target;
        if (!form || !contentRoot.contains(form)) {
            return;
        }
        event.preventDefault();
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);
        const action = getAbsoluteUrl(form.action || window.location.href);
        if ((form.method || "GET").toUpperCase() === "GET") {
            const queryString = params.toString();
            load(queryString ? `${action.split("?")[0]}?${queryString}` : action, { replace: false });
            return;
        }
        load(action, {
            method: "POST",
            body: params.toString(),
            headers: { "Content-Type": "application/x-www-form-urlencoded" }
        });
    });

    window.addEventListener("popstate", event => {
        const target = (event.state && event.state.url) || window.location.href;
        load(target, { replace: true });
    });
});
</script>
</body>
</html>