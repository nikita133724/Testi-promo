<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; overflow-x: hidden;}
        *, *::before, *::after {
            box-sizing: border-box;
        }
        .wrapper { display: flex; height: 100vh; }
        .sidebar {
            width: 220px;
            background: #1f2937;
            color: white;
            padding: 20px;
        }
        .sidebar a {
            display: block;
            color: white;
            text-decoration: none;
            margin: 10px 0;
        }
        .content {
            flex: 1;
            padding: 30px;
            background: #f3f4f6;
            overflow-y: auto;
        }

        /* Общие стили таблиц */
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 30px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px 12px;
            text-align: center;
        }
        th {
            background-color: #556B2F;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        h2, h3 { margin: 10px 0; }
        
        @media (max-width: 900px) {
            .wrapper {
                flex-direction: row;
            }
        
            .sidebar {
                width: 64px;
                padding: 10px 6px;
                align-items: center;
            }
        
            .sidebar h2 {
                display: none;
            }
        
            .sidebar a {
                font-size: 12px;
                padding: 8px 6px;
                margin: 6px 0;
                text-align: center;
                border-radius: 6px;
                background: #374151;
            }
        
            .content {
                padding: 12px;
            }
        }
    </style>
    <link rel="stylesheet" href="{{ request.url_for('static', path='admin_dark.css') }}">
</head>

<body>
<div class="wrapper">
    <aside class="sidebar">
        <h2>Admin</h2>
        <a href="/admin/users">Пользователи</a>
        <a href="/admin/keys">Генерация ключей</a>
        <a href="/admin/stats">Статистика по посту</a>
        <a href="/admin/monitor">Мониторинг</a>
        
        {% if request.session.get("is_admin") %}
            <a href="/logout">Выйти</a>
        {% endif %}
    </aside>

    <main class="content">
        {% block content %}{% endblock %}
    </main>
</div>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const contentRoot = document.querySelector(".content");
    if (!contentRoot) {
        return;
    }

    const parser = new DOMParser();
    const getAbsoluteUrl = raw => new URL(raw, window.location.href).href;
    const pushHistory = (url, replace = false) => {
        if (replace) {
            window.history.replaceState({ url }, "", url);
        } else {
            window.history.pushState({ url }, "", url);
        }
    };
    pushHistory(window.location.href, true);

    const render = (html, url, { replace = false } = {}) => {
        const doc = parser.parseFromString(html, "text/html");
        const newContent = doc.querySelector(".content");
        if (!newContent) {
            throw new Error("content wrapper missing");
        }

        const scripts = Array.from(newContent.querySelectorAll("script"));
        scripts.forEach(script => script.remove());
        if (window.__cleanupMonitor) {
            window.__cleanupMonitor();
            delete window.__cleanupMonitor;
        }
        contentRoot.innerHTML = newContent.innerHTML;

        scripts.forEach(oldScript => {
            const script = document.createElement("script");
            Array.from(oldScript.attributes).forEach(attr => {
                script.setAttribute(attr.name, attr.value);
            });
            script.textContent = oldScript.textContent;
            contentRoot.appendChild(script);
        });

        document.title = doc.title || document.title;
        pushHistory(url, replace);
    };

    const safeFetch = async (url, options = {}) => {
        try {
            const response = await fetch(url, {
                method: options.method || "GET",
                headers: {
                    "X-Requested-With": "SPA",
                    ...(options.headers || {})
                },
                body: options.body,
                credentials: "same-origin"
            });

            if (response.redirected) {
                return { redirected: true, url: response.url };
            }
            if (!response.ok) {
                throw new Error("network");
            }
            return { html: await response.text() };
        } catch (error) {
            return { error };
        }
    };

    const load = async (rawUrl, options = {}) => {
        const url = getAbsoluteUrl(rawUrl);
        const result = await safeFetch(url, options);

        if (result.redirected) {
            return load(result.url, { method: "GET", replace: options.replace });
        }
        if (result.error || !result.html) {
            window.location.href = url;
            return;
        }

        try {
            render(result.html, url, { replace: options.replace });
        } catch {
            window.location.href = url;
        }
    };

    document.body.addEventListener("click", event => {
        const anchor = event.target.closest("a");
        if (!anchor || anchor.target === "_blank" || anchor.href.startsWith("javascript:")) {
            return;
        }
        const url = new URL(anchor.href, window.location.href);
        if (url.origin !== window.location.origin) {
            return;
        }
        if (!anchor.closest(".sidebar") && !anchor.closest(".content")) {
            return;
        }
        event.preventDefault();
        load(url.href, { replace: false });
    });

    document.body.addEventListener("submit", event => {
        const form = event.target;
        if (!form || !contentRoot.contains(form)) {
            return;
        }
        event.preventDefault();
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);
        const action = getAbsoluteUrl(form.action || window.location.href);
        if ((form.method || "GET").toUpperCase() === "GET") {
            const queryString = params.toString();
            load(queryString ? `${action.split("?")[0]}?${queryString}` : action, { replace: false });
            return;
        }
        load(action, {
            method: "POST",
            body: params.toString(),
            headers: { "Content-Type": "application/x-www-form-urlencoded" }
        });
    });

    window.addEventListener("popstate", event => {
        const target = (event.state && event.state.url) || window.location.href;
        load(target, { replace: true });
    });
});
</script>
</body>
</html>
