<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Panel</title>
    <style>
        :root{
            font-family: "Inter", "Segoe UI", system-ui, sans-serif;
            background: #0f172a;
            color: #f1f5f9;
        }
        * { box-sizing: border-box; }

        html, body { height: 100%; margin: 0; }

        /* Общая обёртка */
        .app-shell {
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 28px;
            gap: 24px;
        }

        /* Карточка вокруг layout (центрирует и даёт фон) */
        .panel {
            width: min(1200px, 100%);
            display: flex;
            border-radius: 18px;
            overflow: hidden;
            background: linear-gradient(180deg, #0b1220, #111827);
            box-shadow: 0 20px 50px rgba(2,6,23,0.6);
            border: 1px solid rgba(148,163,184,0.12);
        }

        /* Sidebar */
        aside.sidebar {
            width: 220px;
            background: linear-gradient(180deg, #0b1324, #111827);
            padding: 24px;
            color: #e6eef8;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        aside.sidebar h2 {
            margin: 0 0 12px;
            font-size: 18px;
            color: #ffffff;
            letter-spacing: 0.02em;
        }

        aside.sidebar a {
            display: block;
            color: #cfe8ff;
            text-decoration: none;
            margin: 6px 0;
            padding: 10px 12px;
            border-radius: 10px;
            transition: background .15s ease, transform .06s ease;
            font-weight: 600;
        }

        aside.sidebar a:hover {
            background: rgba(255,255,255,0.03);
            transform: translateX(4px);
        }

        /* Content area */
        main.content {
            flex: 1;
            padding: 28px;
            background: transparent;
            overflow: auto;
        }

        /* Заголовки в контенте */
        .content h1, .content h2, .content h3 {
            margin: 0 0 12px 0;
            color: #e6eef8;
        }

        /* Кнопки одного стиля */
        .btn {
            display: inline-block;
            border: none;
            border-radius: 12px;
            padding: 10px 14px;
            font-weight: 700;
            cursor: pointer;
            transition: transform .12s ease, opacity .12s ease;
            text-decoration: none;
            color: #0f172a;
            background: #38bdf8;
        }
        .btn:active { transform: translateY(1px); }
        .btn.secondary {
            background: rgba(148,163,184,0.12);
            color: #cbd5e1;
            border: 1px solid rgba(148,163,184,0.2);
        }

        /* Карточки внутри контента */
        .card {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border: 1px solid rgba(148,163,184,0.06);
            padding: 18px;
            border-radius: 14px;
            color: #e6eef8;
            margin-bottom: 18px;
        }

        /* Таблицы — адаптированы под тему */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 18px;
            color: #e6eef8;
        }
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(148,163,184,0.06);
            font-size: 14px;
        }
        th {
            font-weight: 700;
            background: rgba(255,255,255,0.02);
            color: #dbeafe;
        }
        tr:nth-child(even) td {
            background: rgba(255,255,255,0.01);
        }

        /* Small screens */
        @media (max-width: 960px) {
            .panel { flex-direction: column; border-radius: 12px; }
            aside.sidebar { width: 100%; flex-direction: row; gap: 8px; padding: 12px; overflow-x: auto; }
            aside.sidebar a { white-space: nowrap; padding: 8px 10px; }
            .app-shell { padding: 16px; }
        }

        /* Utility classes */
        .muted { color: #94a3b8; }
        .right { text-align: right; }
        .gap { gap: 12px; display: flex; align-items: center; }
        .filters { display:flex; gap:8px; margin-bottom:12px; }
        .filter-btn {
            padding: 6px 10px;
            border-radius: 10px;
            background: rgba(148,163,184,0.06);
            color: #cbd5e1;
            cursor: pointer;
            border: none;
            font-weight: 600;
        }
        .filter-btn.active { background: #4CAF50; color: white; }

        /* Preserve previous layout JS behavior: content root focus styles */
        .content :focus { outline: 2px solid rgba(56,189,248,0.14); outline-offset: 2px; }
    </style>
</head>
<body>
<div class="app-shell">
    <div class="panel">
        <aside class="sidebar">
            <h2>Admin</h2>
            <a href="/admin/users">Пользователи</a>
            <a href="/admin/keys">Генерация ключей</a>
            <a href="/admin/stats">Статистика по постам</a>
            <a href="/admin/monitor">Мониторинг</a>

            {% if request.session.get("is_admin") %}
                <a href="/logout" style="margin-top:8px;">Выйти</a>
            {% endif %}
        </aside>

        <main class="content">
            {% block content %}{% endblock %}
        </main>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const contentRoot = document.querySelector(".content");
    if (!contentRoot) {
        return;
    }

    const parser = new DOMParser();
    const getAbsoluteUrl = raw => new URL(raw, window.location.href).href;
    const pushHistory = (url, replace = false) => {
        if (replace) {
            window.history.replaceState({ url }, "", url);
        } else {
            window.history.pushState({ url }, "", url);
        }
    };
    pushHistory(window.location.href, true);

    const render = (html, url, { replace = false } = {}) => {
        const doc = parser.parseFromString(html, "text/html");
        const newContent = doc.querySelector(".content");
        if (!newContent) {
            throw new Error("content wrapper missing");
        }

        const scripts = Array.from(newContent.querySelectorAll("script"));
        scripts.forEach(script => script.remove());
        if (window.__cleanupMonitor) {
            window.__cleanupMonitor();
            delete window.__cleanupMonitor;
        }
        contentRoot.innerHTML = newContent.innerHTML;

        scripts.forEach(oldScript => {
            const script = document.createElement("script");
            Array.from(oldScript.attributes).forEach(attr => {
                script.setAttribute(attr.name, attr.value);
            });
            script.textContent = oldScript.textContent;
            contentRoot.appendChild(script);
        });

        document.title = doc.title || document.title;
        pushHistory(url, replace);
    };

    const safeFetch = async (url, options = {}) => {
        try {
            const response = await fetch(url, {
                method: options.method || "GET",
                headers: {
                    "X-Requested-With": "SPA",
                    ...(options.headers || {})
                },
                body: options.body,
                credentials: "same-origin"
            });

            if (response.redirected) {
                return { redirected: true, url: response.url };
            }
            if (!response.ok) {
                throw new Error("network");
            }
            return { html: await response.text() };
        } catch (error) {
            return { error };
        }
    };

    const load = async (rawUrl, options = {}) => {
        const url = getAbsoluteUrl(rawUrl);
        const result = await safeFetch(url, options);

        if (result.redirected) {
            return load(result.url, { method: "GET", replace: options.replace });
        }
        if (result.error || !result.html) {
            window.location.href = url;
            return;
        }

        try {
            render(result.html, url, { replace: options.replace });
        } catch {
            window.location.href = url;
        }
    };

    document.body.addEventListener("click", event => {
        const anchor = event.target.closest("a");
        if (!anchor || anchor.target === "_blank" || anchor.href.startsWith("javascript:")) {
            return;
        }
        const url = new URL(anchor.href, window.location.href);
        if (url.origin !== window.location.origin) {
            return;
        }
        if (!anchor.closest(".sidebar") && !anchor.closest(".content")) {
            return;
        }
        event.preventDefault();
        load(url.href, { replace: false });
    });

    document.body.addEventListener("submit", event => {
        const form = event.target;
        if (!form || !contentRoot.contains(form)) {
            return;
        }
        event.preventDefault();
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);
        const action = getAbsoluteUrl(form.action || window.location.href);
        if ((form.method || "GET").toUpperCase() === "GET") {
            const queryString = params.toString();
            load(queryString ? `${action.split("?")[0]}?${queryString}` : action, { replace: false });
            return;
        }
        load(action, {
            method: "POST",
            body: params.toString(),
            headers: { "Content-Type": "application/x-www-form-urlencoded" }
        });
    });

    window.addEventListener("popstate", event => {
        const target = (event.state && event.state.url) || window.location.href;
        load(target, { replace: true });
    });
});
</script>
</body>
</html>