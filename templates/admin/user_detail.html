{% extends "admin/layout.html" %}

{% block content %}
<h1>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h1>

<p><strong>Username:</strong> <span id="username">{{ username }}</span></p>
<p><strong>chat_id:</strong> {{ chat_id }}</p>
<p><strong>–°–ª–µ–¥—É—é—â–∏–π refresh:</strong> 
    <span id="refresh-text"></span>
</p>
<p><strong>–°–∞–π—Ç:</strong> <a href="{{ profile_link }}" target="_blank">{{ site_name }}</a></p>
<p>
    <strong>–°—Ç–∞—Ç—É—Å:</strong> 
    <span id="status-text"></span>
</p>

<h3>–î–µ–π—Å—Ç–≤–∏—è</h3>

<div id="time-picker" style="display:none; margin-top:12px; border:1px solid #aaa; padding:12px; background:#fff;">
    <b>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è:</b><br><br>
    <input type="datetime-local" id="custom-datetime"><br><br>
    <button type="button" onclick="applyTime()" style="padding:8px 16px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    <button type="button" onclick="closePicker()" style="padding:8px 16px; margin-left:10px; border:1px solid #ccc; background:white; border-radius:4px; cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
</div>

<div id="subscription-actions" style="margin-top:15px;">
    {% if status == "–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" %}
        <button type="button" id="restore-subscription" style="padding:8px 16px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer;">üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    {% else %}
        <button type="button" id="suspend-subscription" style="padding:8px 16px; background:#dc2626; color:white; border:none; border-radius:4px; cursor:pointer;">‚è∏ –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <button type="button" id="extend-subscription" style="padding:8px 16px; margin-left:10px; background:#2563eb; color:white; border:none; border-radius:4px; cursor:pointer;">‚ûï –ü—Ä–æ–¥–ª–∏—Ç—å</button>
    {% endif %}
</div>

<form id="tokens-form" style="margin-top:10px;">
    <button type="button" id="toggle-tokens" style="padding:8px 16px; background:#666; color:white; border:none; border-radius:4px; cursor:pointer;">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–∫–µ–Ω—ã</button>
</form>

<div id="tokens-container" style="display:none; margin-top:10px; padding:10px; background:#f5f5f5; border-radius:4px;">
    <p><strong>Access Token:</strong><br><span id="access-token" style="word-break:break-all; font-family:monospace;"></span></p>
    <p><strong>Refresh Token:</strong><br><span id="refresh-token" style="word-break:break-all; font-family:monospace; cursor:pointer; user-select: all; padding:5px; background:white;"></span></p>
</div>

<a href="/admin/users" onclick="handleNavClick(event, '/admin/users')" style="display:inline-block; margin-top:20px; color:#2563eb; text-decoration:none;">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>

<script>
let mode = null;

function openPicker(action) {
    mode = action;
    document.getElementById("time-picker").style.display = "block";
}

function closePicker() {
    document.getElementById("time-picker").style.display = "none";
}

async function applyTime() {
    const input = document.getElementById("custom-datetime").value;
    if (!input) { 
        alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è"); 
        return; 
    }

    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const chatId = getChatIdFromUrl();

    const endpoint = mode === "restore" 
        ? `/admin/users/${chatId}/restore_subscription_custom`
        : `/admin/users/${chatId}/extend_subscription_custom`;

    try {
        const resp = await fetch(endpoint, {
            method: "POST",
            headers: {"Content-Type": "application/x-www-form-urlencoded"},
            body: `local_datetime=${encodeURIComponent(input)}&tz=${encodeURIComponent(tz)}`
        });
        const data = await resp.json();

        if (data.ok) {
            const msTime = new Date(input).getTime();
            document.getElementById("status-text").innerText = "–∞–∫—Ç–∏–≤–µ–Ω –¥–æ " + new Date(msTime).toLocaleString();
            closePicker();
            alert(mode === 'restore' ? "–ü–æ–¥–ø–∏—Å–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!" : "–ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∞!");
            
            if(mode === "restore") {
                document.getElementById("subscription-actions").innerHTML = `
                    <button type="button" id="suspend-subscription" style="padding:8px 16px; background:#dc2626; color:white; border:none; border-radius:4px; cursor:pointer;">‚è∏ –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                    <button type="button" id="extend-subscription" style="padding:8px 16px; margin-left:10px; background:#2563eb; color:white; border:none; border-radius:4px; cursor:pointer;">‚ûï –ü—Ä–æ–¥–ª–∏—Ç—å</button>
                `;
                setupPageEventHandlers();
            }
        } else {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏");
        }
    } catch (error) {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏');
    }
}

function getChatIdFromUrl() {
    const match = window.location.pathname.match(/\/admin\/users\/(\d+)/);
    return match ? match[1] : null;
}

const toggleTokensBtn = document.getElementById("toggle-tokens");
const tokensContainer = document.getElementById("tokens-container");
const accessTokenEl = document.getElementById("access-token");
const refreshTokenEl = document.getElementById("refresh-token");

let tokensVisible = false;

toggleTokensBtn.addEventListener("click", async () => {
    if (!tokensVisible) {
        const chatId = getChatIdFromUrl();
        try {
            const resp = await fetch(`/admin/users/${chatId}/tokens`, {
                method: "POST",
                headers: {"x-requested-with": "XMLHttpRequest"}
            });
            const data = await resp.json();
            accessTokenEl.textContent = data.access_token || "(–ø—É—Å—Ç–æ)";
            refreshTokenEl.textContent = data.refresh_token || "(–ø—É—Å—Ç–æ)";

            tokensContainer.style.display = "block";
            toggleTokensBtn.textContent = "–°–∫—Ä—ã—Ç—å —Ç–æ–∫–µ–Ω—ã";
            tokensVisible = true;
        } catch (error) {
            console.error('Error:', error);
        }
    } else {
        tokensContainer.style.display = "none";
        toggleTokensBtn.textContent = "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–∫–µ–Ω—ã";
        tokensVisible = false;
    }
});

refreshTokenEl.addEventListener("click", () => {
    navigator.clipboard.writeText(refreshTokenEl.textContent)
        .then(() => alert("Refresh-—Ç–æ–∫–µ–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!"))
        .catch(err => console.error(err));
});

const status = "{{ status }}";
const displayUntilTs = {{ display_until if display_until else "null" }};
const nextRefreshTs = {{ next_refresh if next_refresh else "null" }};
const statusEl = document.getElementById("status-text");
const refreshEl = document.getElementById("refresh-text");

if (status === "–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" || !displayUntilTs) {
    statusEl.innerText = "–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω";
} else {
    const d = new Date(displayUntilTs * 1000);
    statusEl.innerText = "–∞–∫—Ç–∏–≤–µ–Ω –¥–æ " + d.toLocaleString();
}

if (!nextRefreshTs) {
    refreshEl.innerText = "–Ω–µ –∑–∞–¥–∞–Ω–æ";
} else {
    const d = new Date(nextRefreshTs * 1000);
    refreshEl.innerText = d.toLocaleString();
}

// –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è
const suspendBtn = document.getElementById("suspend-subscription");
const extendBtn = document.getElementById("extend-subscription");
const restoreBtn = document.getElementById("restore-subscription");

if (suspendBtn) {
    suspendBtn.addEventListener("click", async () => {
        const chatId = getChatIdFromUrl();
        try {
            const resp = await fetch(`/admin/users/${chatId}/toggle_status`, {
                method: "POST",
                headers: {"x-requested-with": "XMLHttpRequest"}
            });
            if (resp.ok) {
                document.getElementById("status-text").innerText = "–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω";
                document.getElementById("subscription-actions").innerHTML = `<button type="button" id="restore-subscription" style="padding:8px 16px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer;">üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>`;
                setupPageEventHandlers();
                alert("–ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!");
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });
}

if (extendBtn) {
    extendBtn.addEventListener("click", () => openPicker('extend'));
}

if (restoreBtn) {
    restoreBtn.addEventListener("click", () => openPicker('restore'));
}
</script>

{% endblock %}
