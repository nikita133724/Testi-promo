{% extends "admin/layout.html" %}

{% block content %}
<div class="user-detail-container">
    <h1>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h1>

    <p><strong>Username:</strong> 
        <a href="https://t.me/{{ username }}" target="_blank" id="username">{{ username }}</a>
    </p>
    <p><strong>chat_id:</strong> <span id="chat-id">{{ chat_id }}</span></p>
    <p><strong>–°–ª–µ–¥—É—é—â–∏–π refresh:</strong> <span id="refresh-text"></span></p>
    <p><strong>–°–∞–π—Ç:</strong> <a href="{{ profile_link }}" target="_blank">{{ site_name }}</a></p>
    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="status-text"></span></p>

    <h3>–î–µ–π—Å—Ç–≤–∏—è</h3>

    <div id="time-picker" style="display:none;">
        <b>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è:</b><br><br>
        <input type="datetime-local" id="custom-datetime"><br><br>
        <button type="button" onclick="applyTime()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button type="button" onclick="closePicker()">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <div id="subscription-actions">
        {% if status == "–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" %}
            <button type="button" id="restore-subscription">üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        {% else %}
            <button type="button" id="suspend-subscription">‚è∏ –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            <button type="button" id="extend-subscription">‚ûï –ü—Ä–æ–¥–ª–∏—Ç—å</button>
        {% endif %}
    </div>

    <form id="tokens-form">
        <button type="button" id="toggle-tokens">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–∫–µ–Ω—ã</button>
    </form>

    <div id="tokens-container" style="display:none;">
        <p><strong>Access Token:</strong> <span id="access-token"></span></p>
        <p><strong>Refresh Token:</strong> <span id="refresh-token" style="cursor:pointer; user-select: all;"></span></p>
    </div>

    <a href="/admin/users" class="back-link">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
</div>

<script>
function initUserDetail() {
    let mode = null;

    function openPicker(action) {
        mode = action; // restore | extend
        document.getElementById("time-picker").style.display = "block";
    }

    function closePicker() {
        document.getElementById("time-picker").style.display = "none";
    }

    async function applyTime() {
        const input = document.getElementById("custom-datetime").value;
        if (!input) { alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è"); return; }

        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const endpoint = mode === "restore" 
            ? `/admin/users/{{ chat_id }}/restore_subscription_custom`
            : `/admin/users/{{ chat_id }}/extend_subscription_custom`;

        const resp = await fetch(endpoint, {
            method: "POST",
            headers: {"Content-Type": "application/x-www-form-urlencoded"},
            body: `local_datetime=${encodeURIComponent(input)}&tz=${encodeURIComponent(tz)}`
        });
        const data = await resp.json();

        if (data.ok) {
            const msTime = new Date(input).getTime();
            const statusEl = document.getElementById("status-text");
            statusEl.innerText = "–∞–∫—Ç–∏–≤–µ–Ω –¥–æ " + new Date(msTime).toLocaleString();
            statusEl.style.color = "#4CAF50";
            closePicker();
            alert(mode === 'restore' ? "–ü–æ–¥–ø–∏—Å–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!" : "–ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∞!");
            if(mode === "restore") {
                document.getElementById("subscription-actions").innerHTML = `
                    <button type="button" id="suspend-subscription">‚è∏ –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                    <button type="button" id="extend-subscription">‚ûï –ü—Ä–æ–¥–ª–∏—Ç—å</button>
                `;
                bindSuspendExtendButtons();
            }
        } else {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏");
        }
    }

    function bindSuspendExtendButtons() {
        const suspendBtn = document.getElementById("suspend-subscription");
        if (suspendBtn) {
            suspendBtn.addEventListener("click", async () => {
                const resp = await fetch(`/admin/users/{{ chat_id }}/toggle_status`, {
                    method: "POST",
                    headers: {"x-requested-with": "XMLHttpRequest"}
                });
                if (resp.ok) {
                    const statusEl = document.getElementById("status-text");
                    statusEl.innerText = "–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω";
                    statusEl.style.color = "#FF1C1C";
                    document.getElementById("subscription-actions").innerHTML = `<button type="button" id="restore-subscription">üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>`;
                    bindRestoreButton();
                    alert("–ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!");
                }
            });
        }

        const extendBtn = document.getElementById("extend-subscription");
        if (extendBtn) {
            extendBtn.addEventListener("click", () => openPicker('extend'));
        }
    }

    function bindRestoreButton() {
        const restoreBtn = document.getElementById("restore-subscription");
        if (restoreBtn) {
            restoreBtn.addEventListener("click", () => openPicker('restore'));
        }
    }

    bindSuspendExtendButtons();
    bindRestoreButton();

    // –¢–æ–∫–µ–Ω—ã
    const toggleTokensBtn = document.getElementById("toggle-tokens");
    const tokensContainer = document.getElementById("tokens-container");
    const accessTokenEl = document.getElementById("access-token");
    const refreshTokenEl = document.getElementById("refresh-token");
    let tokensVisible = false;
    toggleTokensBtn.addEventListener("click", async () => {
        if (!tokensVisible) {
            const resp = await fetch(`/admin/users/{{ chat_id }}/tokens`, {
                method: "POST",
                headers: {"x-requested-with": "XMLHttpRequest"}
            });
            const data = await resp.json();
            accessTokenEl.textContent = data.access_token;
            refreshTokenEl.textContent = data.refresh_token;
            tokensContainer.style.display = "block";
            toggleTokensBtn.textContent = "–°–∫—Ä—ã—Ç—å —Ç–æ–∫–µ–Ω—ã";
            tokensVisible = true;
        } else {
            tokensContainer.style.display = "none";
            toggleTokensBtn.textContent = "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–∫–µ–Ω—ã";
            tokensVisible = false;
        }
    });

    // –ê–≤—Ç–æ–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ chat_id
    const chatIdEl = document.getElementById("chat-id");
    chatIdEl.style.cursor = "pointer";
    chatIdEl.title = "–ö–ª–∏–∫ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è";
    chatIdEl.addEventListener("click", () => {
        navigator.clipboard.writeText(chatIdEl.textContent)
            .then(() => alert("chat_id —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!"))
            .catch(err => console.error(err));
    });

    // –°—Ç–∞—Ç—É—Å –∏ refresh
    const statusEl = document.getElementById("status-text");
    const refreshEl = document.getElementById("refresh-text");
    const displayUntilTs = {{ display_until if display_until else "null" }};
    const nextRefreshTs = {{ next_refresh if next_refresh else "null" }};

    if ("{{ status }}" === "–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" || !displayUntilTs) {
        statusEl.innerText = "–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω";
        statusEl.style.color = "#FF1C1C";
    } else {
        const d = new Date(displayUntilTs * 1000);
        statusEl.innerText = "–∞–∫—Ç–∏–≤–µ–Ω –¥–æ " + d.toLocaleString();
        statusEl.style.color = "#4CAF50";
    }

    if (!nextRefreshTs) {
        refreshEl.innerText = "–Ω–µ –∑–∞–¥–∞–Ω–æ";
    } else {
        const d = new Date(nextRefreshTs * 1000);
        refreshEl.innerText = d.toLocaleString();
    }
}
</script>

<style>
.user-detail-container {
    color: var(--text-color);
    background: linear-gradient(180deg, var(--bg-gradient-start), var(--bg-gradient-end));
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    width: 100%;
    max-width: 900px;
    margin: 0 auto 40px auto;
    font-family: var(--font-family);
}

.user-detail-container h1,
.user-detail-container h3 {
    color: var(--text-color);
}

.user-detail-container p {
    display: flex;
    align-items: center;
    margin: 8px 0;
    font-size: 16px;
}

.user-detail-container p strong {
    margin-right: 6px;
    min-width: auto;
}

.user-detail-container a {
    color: #38bdf8;
    text-decoration: none;
}

.user-detail-container a:hover {
    text-decoration: underline;
}

.back-link {
    display: inline-block;
    margin-top: 20px;
    color: #38bdf8;
    text-decoration: none;
}
.back-link:hover {
    text-decoration: underline;
}

#time-picker {
    background: rgba(255,255,255,0.05);
    padding: 12px;
    border-radius: 8px;
    margin-top: 12px;
}

#subscription-actions button,
#tokens-form button {
    margin-top: 8px;
    margin-right: 8px;
    border-radius: 8px;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
    background: var(--btn-bg);
    color: #0f172a;
    transition: 0.2s;
}

#subscription-actions button:hover,
#tokens-form button:hover {
    background: var(--btn-hover);
}
</style>
{% endblock %}