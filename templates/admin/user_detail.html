{% extends "admin/layout.html" %}

{% block content %}
<h1>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h1>

<p><strong>Username:</strong> {{ username }}</p>
<p><strong>chat_id:</strong> {{ chat_id }}</p>
<p><strong>–°–ª–µ–¥—É—é—â–∏–π refresh:</strong> {{ next_refresh }}</p>
<p><strong>–°–∞–π—Ç:</strong> <a href="{{ profile_link }}" target="_blank">{{ site_name }}</a></p>
<p>
    <strong>–°—Ç–∞—Ç—É—Å:</strong> 
    <span id="status-text"></span>

    {% if status == "–∞–∫—Ç–∏–≤–µ–Ω" %}
        <button type="button" onclick="openPicker('extend')" style="margin-left:10px;">
            ‚ûï –ü—Ä–æ–¥–ª–∏—Ç—å
        </button>
    {% endif %}
</p>

<h3>–î–µ–π—Å—Ç–≤–∏—è</h3>
<div id="time-picker" style="display:none; margin-top:12px; border:1px solid #aaa; padding:12px;">
    <b>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è:</b><br><br>

    <input type="datetime-local" id="custom-datetime">

    <br><br>
    <button type="button" onclick="applyTime()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    <button type="button" onclick="closePicker()">–û—Ç–º–µ–Ω–∞</button>
</div>
{% if "–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" in status %}
    <button type="button" onclick="openPicker('restore')">üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
{% else %}
    <form method="post" action="/admin/users/{{ chat_id }}/toggle_status" style="display:inline;">
        <button type="submit">‚è∏ –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    </form>
{% endif %}


<form method="post" action="/admin/users/{{ chat_id }}/tokens" style="display:inline-block; margin-left:10px;">
    <button type="submit">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–∫–µ–Ω—ã</button>
</form>

<a href="/admin/users" style="margin-left:20px;">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>

{% if tokens %}
<h3>–¢–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
<p><strong>Access Token:</strong> {{ tokens.access_token }}</p>
<p><strong>Refresh Token:</strong> {{ tokens.refresh_token }}</p>
{% endif %}

<script>
let mode = null;

function openPicker(action) {
    mode = action; // restore | extend
    document.getElementById("time-picker").style.display = "block";
}

function closePicker() {
    document.getElementById("time-picker").style.display = "none";
}

function applyTime() {
    const input = document.getElementById("custom-datetime").value;
    if (!input) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è");
        return;
    }

    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;

    fetch(`/admin/users/{{ chat_id }}/${mode}_subscription_custom`, {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: `local_datetime=${encodeURIComponent(input)}&tz=${encodeURIComponent(tz)}`
    }).then(() => location.reload());
}
</script>
<script>
const status = "{{ status }}";
const ts = {{ display_until if display_until else "null" }};

const statusEl = document.getElementById("status-text");

if (status === "–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" || !ts) {
    statusEl.innerText = "–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω";
} else {
    const d = new Date(ts * 1000);
    statusEl.innerText = "–∞–∫—Ç–∏–≤–µ–Ω –¥–æ " + d.toLocaleString();
}
</script>
{% endblock %}
